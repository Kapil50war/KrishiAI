<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§ï‡•É‡§∑‡•Ä ‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø ‡§∏‡§≤‡•ç‡§≤‡§æ‡§ó‡§æ‡§∞ AI (‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Light gray background */
        }
        .container-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #result-content {
            line-height: 1.6;
        }
        .result-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #166534;
        }
        .visual-aid-img {
            min-height: 100px;
            width: 100%;
            height: auto;
            object-fit: contain;
            border-radius: 4px;
        }
        .copy-text {
            cursor: pointer;
            text-decoration: underline;
            color: #1d4ed8;
        }
        /* Style for the single upload button which acts as a label */
        .upload-button-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            height: 100%; 
            border: 2px dashed #10b981;
            background-color: #ecfdf5; /* Green 50 */
            color: #10b981; /* Green 600 */
            width: 100%;
        }
        .upload-button-label:hover {
            background-color: #d1fae5; /* Green 100 */
        }

        /* VISUALLY HIDE THE ACTUAL FILE INPUT but keep it functional for the browser */
        .visually-hidden-input {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-center justify-center">

    <div id="app" class="w-full max-w-lg bg-white rounded-xl container-card p-6 sm:p-8">
        <h1 class="text-3xl font-extrabold text-green-700 mb-2 text-center">
            ‡§ï‡•É‡§∑‡•Ä ‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø ‡§∏‡§≤‡•ç‡§≤‡§æ‡§ó‡§æ‡§∞ AI
        </h1>
        
        <p class="text-center text-gray-500 mb-6">‡§∞‡•ã‡§ó‡§ó‡•ç‡§∞‡§∏‡•ç‡§§ ‡§™‡•Ä‡§ï ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§∂‡•á‡§§‡§æ‡§§‡•Ä‡§≤ ‡§§‡§£/‡§ó‡§µ‡§§, ‡§ï‡§∂‡§æ‡§ö‡§æ‡§π‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ ‡§Ü‡§£‡§ø ‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§â‡§™‡§æ‡§Ø ‡§Æ‡§ø‡§≥‡§µ‡§æ.</p>

        <!-- Image Upload Area (Simplified) -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">‡•ß. ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ</label>
            
            <div class="input-group relative h-16">
                <!-- Single Label/Button for Upload -->
                <label for="file-upload" class="upload-button-label">
                    <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-1-5a2 2 0 11-4 0 2 2 0 014 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 20h16a2 2 0 002-2V6a2 2 0 00-2-2H4a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    ‡§´‡•ã‡§ü‡•ã ‡§®‡§ø‡§µ‡§°‡§æ
                </label>
                <!-- Single File Input (allows camera or gallery selection based on OS dialog) -->
                <input type="file" id="file-upload" accept="image/*" class="visually-hidden-input" onchange="previewImage(event)">
            </div>
        </div>

        <!-- Image Preview -->
        <div id="image-preview-container" class="mb-6 h-48 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-300 transition-all duration-300">
            <p id="preview-text" class="text-gray-400 text-center">‡§´‡•ã‡§ü‡•ã‡§ö‡•á ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§µ‡§≤‡•ã‡§ï‡§® ‡§Ø‡•á‡§•‡•á ‡§¶‡§ø‡§∏‡•á‡§≤</p>
            <img id="image-preview" class="hidden w-full h-full object-cover" alt="‡§µ‡§®‡§∏‡•ç‡§™‡§§‡•Ä ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§µ‡§≤‡•ã‡§ï‡§®">
        </div>

        <!-- Analysis Button -->
        <button id="analyze-btn" onclick="analyzeImage()" disabled class="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 disabled:bg-green-300 flex items-center justify-center">
            <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="button-text">‡§´‡•ã‡§ü‡•ã‡§ö‡•á ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§æ</span>
        </button>

        <!-- Result Display Area -->
        <div id="result-container" class="mt-8 hidden p-5 bg-green-50 border border-green-200 rounded-lg transition-opacity duration-500 opacity-0">
            <h2 id="report-header" class="result-title mb-3">‡§®‡§ø‡§¶‡§æ‡§® ‡§Ö‡§π‡§µ‡§æ‡§≤</h2>
            <div id="result-content" class="space-y-4">
                <!-- Content will be injected here in Marathi -->
            </div>
            <!-- General Disclaimer for Price -->
            <p class="mt-5 text-xs text-red-700 border-t border-red-200 pt-3">
                **‡§Æ‡§π‡§§‡•ç‡§§‡•ç‡§µ‡§æ‡§ö‡•Ä ‡§®‡•ã‡§Ç‡§¶:** ‡§Ø‡•á‡§•‡•á ‡§¶‡§ø‡§≤‡•á‡§≤‡•Ä ‡§Ö‡§Ç‡§¶‡§æ‡§ú‡§ø‡§§ ‡§ï‡§ø‡§Ç‡§Æ‡§§ ‡§π‡•Ä ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§¨‡§æ‡§ú‡§æ‡§∞‡§≠‡§æ‡§µ‡§æ‡§µ‡§∞ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§Ü‡§π‡•á. ‡§Ö‡§ö‡•Ç‡§ï ‡§ï‡§ø‡§Ç‡§Æ‡§§, ‡§∏‡•ç‡§•‡§æ‡§®‡§ø‡§ï ‡§¨‡•ç‡§∞‡§Å‡§°‡§ö‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß‡§§‡§æ ‡§Ü‡§£‡§ø ‡§Ö‡§®‡•Å‡§¶‡§æ‡§® ‡§§‡§™‡§æ‡§∏‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§ú‡§µ‡§≥‡§ö‡•ç‡§Ø‡§æ **‡§ï‡•É‡§∑‡•Ä ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞** ‡§ï‡§ø‡§Ç‡§µ‡§æ **‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§ï‡•É‡§∑‡•Ä ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä** ‡§Ø‡§æ‡§Ç‡§ö‡•ç‡§Ø‡§æ‡§∂‡•Ä ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§∏‡§æ‡§ß‡§æ.
                <br>
                <span class="text-sm font-bold text-gray-700 block mt-1">By Kapil50war</span>
            </p>
        </div>

        <!-- Error/Message Box -->
        <div id="message-box" class="mt-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-lg hidden"></div>
    </div>

    <script type="module">
        // --- Gemini API Setup ---
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        const API_KEY = ""; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 5;

        // --- DOM Elements ---
        const imagePreview = document.getElementById('image-preview');
        const previewText = document.getElementById('preview-text');
        const analyzeBtn = document.getElementById('analyze-btn');
        const spinner = document.getElementById('spinner');
        const buttonText = document.getElementById('button-text');
        const resultContainer = document.getElementById('result-container');
        const resultContent = document.getElementById('result-content');
        const messageBox = document.getElementById('message-box');
        const reportHeader = document.getElementById('report-header');
        
        // --- Global reference to the file input that triggered the preview ---
        let currentFileInput = null;


        // --- Utility Functions ---

        /** Displays a temporary message in the message box. */
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.className = `mt-4 p-3 rounded-lg ${isError ? 'bg-red-100 border border-red-300 text-red-700' : 'bg-blue-100 border border-blue-300 text-blue-700'}`;
            messageBox.classList.remove('hidden');
        }

        /** Hides the message box. */
        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        /** Converts a File object to a Base64 string for the API payload. */
        function fileToGenerativePart(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64Data = reader.result.split(',')[1];
                    resolve({
                        inlineData: {
                            data: base64Data,
                            mimeType: file.type
                        }
                    });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        /** Creates a dynamic, custom placeholder image URL with product text for reliable display. */
        function getCustomProductPlaceholder(productName, brandName, productType) {
            const textToDisplay = `${brandName} | ${productName}`;
            let baseColor;
            let secondaryColor;
            let productTag;

            if (productType.includes('UREA') || productType.includes('DAP') || productType.includes('NPK') || !productType) {
                baseColor = '007ACC'; 
                secondaryColor = 'FFD700'; 
                productTag = '‡§ñ‡§æ‡§¶ ‡§™‡•ã‡§§‡•á';
            } else {
                baseColor = 'D9534F'; 
                secondaryColor = 'FFFFFF'; 
                productTag = '‡§´‡§µ‡§æ‡§∞‡§£‡•Ä ‡§¨‡§æ‡§ü‡§≤‡•Ä';
            }
            
            const finalDisplay = encodeURIComponent(`[${productTag}] ${textToDisplay}`);

            return `https://placehold.co/400x160/${baseColor}/${secondaryColor}?text=${finalDisplay}&font=roboto&fontsize=18`;
        }
        
        /** Copies the text to the clipboard and gives feedback. */
        window.copyToClipboard = function(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showMessage("‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡§æ‡§ö‡•á ‡§®‡§æ‡§µ ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä‡§∞‡§ø‡§§‡•ç‡§Ø‡§æ ‡§ï‡•â‡§™‡•Ä ‡§ï‡•á‡§≤‡•á!", false);
                } else {
                    throw new Error('Copy failed');
                }
            } catch (err) {
                showMessage("‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä ‡§Ü‡§≤‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡•Ö‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤‡•Ä ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§æ.", true);
            }
            document.body.removeChild(textarea);
        }

        /** Previews the selected image and enables the Analyze button. */
        window.previewImage = function(event) {
            hideMessage();
            resultContainer.classList.add('hidden', 'opacity-0');
            resultContent.innerHTML = '';
            
            // Note: The input ID is now 'file-upload'
            const file = event.target.files[0];
            
            // Set the current file input reference
            currentFileInput = event.target;

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    previewText.classList.add('hidden');
                    analyzeBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.classList.add('hidden');
                previewText.classList.remove('hidden');
                analyzeBtn.disabled = true;
                currentFileInput = null;
            }
        };

        /** Exponential backoff retry logic for API calls. */
        async function makeAPIRequestWithBackoff(payload, maxRetries = MAX_RETRIES) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    }

                    if (response.status === 429 || response.status >= 500) {
                        const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000); 
                        showMessage(`‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä ‡§ù‡§æ‡§≤‡•Ä (${response.status}). ${Math.round(delay / 1000)} ‡§∏‡•á‡§ï‡§Ç‡§¶‡§æ‡§§ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...`, false);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; 
                    }

                    const errorJson = await response.json();
                    throw new Error(`API ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ${response.status} - ${errorJson.error?.message || response.statusText}`);

                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; 
                    }
                    const delay = Math.pow(2, i + 1) * 1000 + (Math.random() * 1000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("‡§Ö‡§®‡•á‡§ï ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§®‡§æ‡§Ç‡§®‡§Ç‡§§‡§∞‡§π‡•Ä API ‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä ‡§ù‡§æ‡§≤‡•Ä.");
        }


        /** Main function to analyze the image and display results. */
        window.analyzeImage = async function() {
            
            // Use the file from the input that last triggered the preview
            const file = currentFileInput ? currentFileInput.files[0] : null;

            if (!file) {
                showMessage("‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ü‡§ß‡•Ä ‡§è‡§ï ‡§™‡•ç‡§∞‡§§‡§ø‡§Æ‡§æ ‡§´‡§æ‡§á‡§≤ ‡§®‡§ø‡§µ‡§°‡§æ.", true);
                return;
            }

            // UI State: Loading
            analyzeBtn.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.textContent = '‡§ï‡•É‡§∑‡•Ä ‡§§‡§ú‡•ç‡§û‡§æ‡§Ç‡§∂‡•Ä ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§∏‡§æ‡§ß‡§§ ‡§Ü‡§π‡•á...'; 
            hideMessage();
            resultContainer.classList.add('hidden', 'opacity-0');
            resultContent.innerHTML = '';


            try {
                // 1. Convert file to Base64 part
                const imagePart = await fileToGenerativePart(file);

                // 2. Define the System Instruction and JSON Schema
                const systemPrompt = `‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§ú‡§æ‡§ó‡§§‡§ø‡§ï ‡§¶‡§∞‡•ç‡§ú‡§æ‡§ö‡•á ‡§ï‡•É‡§∑‡•Ä ‡§∏‡§≤‡•ç‡§≤‡§æ‡§ó‡§æ‡§∞ ‡§Ü‡§π‡§æ‡§§. ‡§µ‡§æ‡§™‡§∞‡§ï‡§∞‡•ç‡§§‡•ç‡§Ø‡§æ‡§®‡•á ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡•á‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡§ø‡§Æ‡•á‡§ö‡•á ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§æ. 
                **‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§æ:** ‡§´‡•ã‡§ü‡•ã ‡§∞‡•ã‡§ó‡§ó‡•ç‡§∞‡§∏‡•ç‡§§ ‡§™‡§ø‡§ï‡§æ‡§ö‡§æ ‡§Ö‡§∏‡•á‡§≤ ‡§§‡§∞ 'CROP_DISEASE' ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§§‡§£/‡§ó‡§µ‡§§‡§æ‡§ö‡§æ ‡§Ö‡§∏‡•á‡§≤ ‡§§‡§∞ 'WEED_CONTROL' ‡§π‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§®‡§ø‡§µ‡§°‡§æ.
                
                **‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§®‡§ø‡§Ø‡§Æ:**
                * ‡§∏‡§∞‡•ç‡§µ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä **‡§´‡§ï‡•ç‡§§ ‡§Æ‡§∞‡§æ‡§†‡•Ä ‡§≠‡§æ‡§∑‡•á‡§§** ‡§Ü‡§£‡§ø **‡§¶‡§ø‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ JSON ‡§∏‡§Ç‡§∞‡§ö‡§®‡•á‡§®‡•Å‡§∏‡§æ‡§∞** ‡§¶‡•ç‡§Ø‡§æ.
                * ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§®‡§∏‡§≤‡•á‡§≤‡•á ‡§´‡•Ä‡§≤‡•ç‡§°‡•ç‡§∏ (‡§â‡§¶‡§æ. weedName) ‡§∞‡§ø‡§ï‡§æ‡§Æ‡•á ‡§†‡•á‡§µ‡§æ ("").
                * ‡§ñ‡§§/‡§§‡§£‡§®‡§æ‡§∂‡§ï ‡§∂‡§ø‡§´‡§æ‡§∞‡§∂‡•Ä‡§Ç‡§∏‡§æ‡§†‡•Ä, ‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§¨‡§æ‡§ú‡§æ‡§∞‡§æ‡§§ ‡§∏‡§π‡§ú ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§Ö‡§∏‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ 3 ‡§µ‡•á‡§ó‡§µ‡•á‡§ó‡§≥‡•ç‡§Ø‡§æ ‡§ï‡§Ç‡§™‡§®‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•ç‡§Ø‡§æ **‡§Ö‡§ö‡•Ç‡§ï ‡§¨‡•ç‡§∞‡§Å‡§° ‡§Ü‡§£‡§ø ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡§æ‡§ö‡•á ‡§®‡§æ‡§µ** (‡§â‡§¶‡§æ. ‡§á‡§´‡§ï‡•ã ‡§Ø‡•Å‡§∞‡§ø‡§Ø‡§æ, ‡§¨‡§æ‡§Ø‡§∞ ‡§∞‡§æ‡§â‡§Ç‡§°‡§Ö‡§™) ‡§¶‡•ç‡§Ø‡§æ.
                * JSON ‡§ï‡•Ä (keys) ‡§á‡§Ç‡§ó‡•ç‡§∞‡§ú‡•Ä‡§§‡§ö ‡§∞‡§æ‡§π‡§§‡•Ä‡§≤, ‡§™‡§£ ‡§µ‡•ç‡§π‡•Ö‡§≤‡•ç‡§Ø‡•Ç (values) ‡§Æ‡§∞‡§æ‡§†‡•Ä‡§§ ‡§Ö‡§∏‡§§‡•Ä‡§≤.`;

                const userQuery = `‡§™‡•ç‡§∞‡§§‡§ø‡§Æ‡§æ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§¶‡§∞‡•ç‡§∂‡§µ‡§ø‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡•á‡§ö‡•á ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§æ. ‡§§‡•Ä ‡§µ‡§®‡§∏‡•ç‡§™‡§§‡•Ä‡§ö‡§æ ‡§∞‡•ã‡§ó ‡§Ü‡§π‡•á ‡§ï‡•Ä ‡§∂‡•á‡§§‡§æ‡§§‡•Ä‡§≤ ‡§§‡§£, ‡§π‡•á ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•Ç‡§®, ‡§§‡•ç‡§Ø‡§æ‡§®‡•Å‡§∏‡§æ‡§∞ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä, ‡§§‡§∏‡•á‡§ö 3 ‡§µ‡•á‡§ó‡§µ‡•á‡§ó‡§≥‡•ç‡§Ø‡§æ ‡§¨‡•ç‡§∞‡§Å‡§°‡§ö‡•ç‡§Ø‡§æ ‡§ñ‡§§/‡§§‡§£‡§®‡§æ‡§∂‡§ï ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡§æ‡§Ç‡§ö‡•Ä ‡§∂‡§ø‡§´‡§æ‡§∞‡§∏ ‡§Æ‡§∞‡§æ‡§†‡•Ä‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§¶‡•ç‡§Ø‡§æ.`;

                const responseSchema = {
                    type: "OBJECT",
                    properties: {
                        "category": { "type": "STRING", "description": "CROP_DISEASE or WEED_CONTROL" },
                        "certaintyScore": { "type": "STRING", "description": "‡§®‡§ø‡§¶‡§æ‡§®‡§æ‡§∏‡§æ‡§†‡•Ä ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§‡§§‡§æ ‡§∏‡•ç‡§§‡§∞ (‡§â‡§¶‡§æ. ‡§â‡§ö‡•ç‡§ö, 90%) ‡§Æ‡§∞‡§æ‡§†‡•Ä‡§§." },
                        
                        // CROP_DISEASE fields
                        "diseaseName": { "type": "STRING", "description": "‡§∞‡•ã‡§ó‡§æ‡§ö‡•á ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§®‡§æ‡§µ ‡§Æ‡§∞‡§æ‡§†‡•Ä‡§§ (WEED_CONTROL ‡§Ö‡§∏‡§≤‡•ç‡§Ø‡§æ‡§∏ ‡§∞‡§ø‡§ï‡§æ‡§Æ‡•á ‡§†‡•á‡§µ‡§æ)." },
                        "reasonAndCause": { "type": "STRING", "description": "‡§∞‡•ã‡§ó‡§æ‡§ö‡•á ‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï ‡§ï‡§æ‡§∞‡§£ (WEED_CONTROL ‡§Ö‡§∏‡§≤‡•ç‡§Ø‡§æ‡§∏ ‡§∞‡§ø‡§ï‡§æ‡§Æ‡•á ‡§†‡•á‡§µ‡§æ)." },
                        "naturalRemedies": {
                            "type": "ARRAY",
                            "description": "‡§®‡•à‡§∏‡§∞‡•ç‡§ó‡§ø‡§ï ‡§â‡§™‡§æ‡§Ø ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§§‡§£ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§§‡§Ç‡§§‡•ç‡§∞‡§æ‡§Ç‡§ö‡•Ä ‡§Ø‡§æ‡§¶‡•Ä ‡§Æ‡§∞‡§æ‡§†‡•Ä‡§§.",
                            "items": { "type": "STRING" }
                        },

                        // WEED_CONTROL fields
                        "weedName": { "type": "STRING", "description": "‡§§‡§£‡§æ‡§ö‡•á/‡§ó‡§µ‡§§‡§æ‡§ö‡•á ‡§®‡§æ‡§µ (CROP_DISEASE ‡§Ö‡§∏‡§≤‡•ç‡§Ø‡§æ‡§∏ ‡§∞‡§ø‡§ï‡§æ‡§Æ‡•á ‡§†‡•á‡§µ‡§æ)." },

                        // Unified Recommendation Array
                        "recommendations": {
                            "type": "ARRAY",
                            "description": "Top 3 recommended products/brands for fertilizer or herbicide.",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "brandName": { "type": "STRING", "description": "‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§ï ‡§ï‡§Ç‡§™‡§®‡•Ä‡§ö‡•á ‡§®‡§æ‡§µ ‡§Æ‡§∞‡§æ‡§†‡•Ä‡§§ (‡§â‡§¶‡§æ. ‡§á‡§´‡§ï‡•ã, ‡§¨‡§æ‡§Ø‡§∞)." },
                                    "productName": { "type": "STRING", "description": "‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡§æ‡§ö‡•á ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§®‡§æ‡§µ (‡§â‡§¶‡§æ. ‡§Ø‡•Å‡§∞‡§ø‡§Ø‡§æ, RoundUp, 10:26:26)." },
                                    "productType": { "type": "STRING", "description": "‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡§æ‡§ö‡§æ ‡§∞‡§æ‡§∏‡§æ‡§Ø‡§®‡§ø‡§ï ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞/‡§ï‡•ã‡§° (‡§â‡§¶‡§æ. UREA, GLYPHOSATE, NPK_10_26_26, DAP)."},
                                    "dosage": { "type": "STRING", "description": "‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£/‡§°‡•ã‡§∏ ‡§Ü‡§£‡§ø ‡§µ‡§æ‡§™‡§∞‡§£‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§™‡§¶‡•ç‡§ß‡§§ ‡§Æ‡§∞‡§æ‡§†‡•Ä‡§§."},
                                    "priceEstimate": { "type": "STRING", "description": "‡§Ö‡§Ç‡§¶‡§æ‡§ú‡§ø‡§§ ‡§ï‡§ø‡§Ç‡§Æ‡§§ ‡§Æ‡§∞‡§æ‡§†‡•Ä‡§§ (‡§â‡§¶‡§æ. ‚Çπ 350 - 450)." },
                                    "sideEffects": { "type": "STRING", "description": "‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡§æ‡§ö‡•á ‡§™‡§ø‡§ï‡§æ‡§µ‡§∞ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§µ‡§æ‡§™‡§∞‡§ï‡§∞‡•ç‡§§‡•ç‡§Ø‡§æ‡§µ‡§∞ ‡§π‡•ã‡§£‡§æ‡§∞‡•á ‡§¶‡•Å‡§∑‡•ç‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§Ü‡§£‡§ø ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§‡§§‡§æ ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§Æ‡§∞‡§æ‡§†‡•Ä‡§§."}
                                }
                            }
                        }
                    },
                    "required": ["category", "certaintyScore", "diseaseName", "reasonAndCause", "naturalRemedies", "weedName", "recommendations"]
                };

                // 3. Construct the API Payload
                const payload = {
                    contents: [{
                        parts: [
                            { text: userQuery },
                            imagePart
                        ]
                    }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: responseSchema
                    },
                };

                // 4. Call the API
                const result = await makeAPIRequestWithBackoff(payload);

                // 5. Parse the Response
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) {
                    throw new Error("AI ‡§ï‡§°‡•Ç‡§® ‡§∞‡§ø‡§ï‡§æ‡§Æ‡•á ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§Ö‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§™‡•ç‡§∞‡§§‡§ø‡§∏‡§æ‡§¶ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ù‡§æ‡§≤‡§æ.");
                }

                // Clean and Parse JSON
                const startIndex = jsonText.indexOf('{');
                const endIndex = jsonText.lastIndexOf('}');
                const cleanedJsonText = jsonText.substring(startIndex, endIndex + 1);

                const parsedData = JSON.parse(cleanedJsonText);
                displayResult(parsedData);
                showMessage("‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ù‡§æ‡§≤‡•á! ‡§ñ‡§æ‡§≤‡•Ä ‡§Ü‡§™‡§≤‡•á ‡§®‡§ø‡§¶‡§æ‡§® ‡§Ü‡§£‡§ø 3 ‡§™‡•ç‡§∞‡§Æ‡•Å‡§ñ ‡§∂‡§ø‡§´‡§æ‡§∞‡§∏‡•Ä ‡§§‡§™‡§æ‡§∏‡§æ.", false);

            } catch (error) {
                console.error("Analysis Failed:", error);
                showMessage(`‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä ‡§ù‡§æ‡§≤‡•á. ${error.message}. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.`, true);
            } finally {
                // UI State: Done
                analyzeBtn.disabled = false;
                spinner.classList.add('hidden');
                buttonText.textContent = '‡§´‡•ã‡§ü‡•ã‡§ö‡•á ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§æ';
            }
        };

        /** Renders the structured data into the result container in Marathi, using reliable visual aids. */
        function displayResult(data) {
            resultContent.innerHTML = ''; // Clear previous content

            const isWeedControl = data.category === 'WEED_CONTROL';

            // Set Header based on category
            reportHeader.textContent = isWeedControl ? '‡§§‡§£ ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§Ö‡§π‡§µ‡§æ‡§≤' : '‡§™‡•Ä‡§ï ‡§∞‡•ã‡§ó ‡§®‡§ø‡§¶‡§æ‡§® ‡§Ö‡§π‡§µ‡§æ‡§≤';
            
            // Helper to create a title block
            const createTitleBlock = (title, content) => {
                return `
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-1">${title}</p>
                        <p class="text-lg font-bold text-green-800">${content}</p>
                    </div>
                `;
            };

            // 1. Primary Identification & Certainty (Header)
            const primaryIdName = isWeedControl ? data.weedName : data.diseaseName;
            const primaryTitle = isWeedControl ? '‡§§‡§£‡§æ‡§ö‡•á/‡§ó‡§µ‡§§‡§æ‡§ö‡•á ‡§®‡§æ‡§µ' : '‡§∞‡•ã‡§ó‡§æ‡§ö‡•á ‡§®‡§ø‡§¶‡§æ‡§®';
            const certaintyClass = data.certaintyScore.toLowerCase().includes('‡§â‡§ö‡•ç‡§ö') || data.certaintyScore.toLowerCase().includes('high') ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800';
            
            resultContent.innerHTML += `
                <div class="p-3 bg-white rounded-lg border-b border-green-100 flex justify-between items-center flex-wrap">
                    ${createTitleBlock(primaryTitle, primaryIdName)}
                    <span class="text-sm px-3 py-1 rounded-full ${certaintyClass} font-medium mt-2 sm:mt-0">
                        ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§‡§§‡§æ: ${data.certaintyScore}
                    </span>
                </div>
            `;

            // 2. Reason/Cause (Only for Crop Disease)
            if (!isWeedControl) {
                resultContent.innerHTML += `
                    <div class="p-3 bg-white rounded-lg">
                        <p class="text-sm font-semibold text-gray-600 mb-1">‡§ï‡§æ‡§∞‡§£/‡§â‡§ó‡§Æ</p>
                        <p class="text-gray-700">${data.reasonAndCause}</p>
                    </div>
                `;
            }

            // 3. Natural Remedies / Management Techniques
            if (data.naturalRemedies && data.naturalRemedies.length > 0) {
                const remediesTitle = isWeedControl ? 'üå± ‡§®‡•à‡§∏‡§∞‡•ç‡§ó‡§ø‡§ï ‡§§‡§£ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§®/‡§â‡§™‡§æ‡§Ø' : 'üåø ‡§®‡•à‡§∏‡§∞‡•ç‡§ó‡§ø‡§ï/‡§™‡§æ‡§∞‡§Ç‡§™‡§∞‡§ø‡§ï ‡§â‡§™‡§æ‡§Ø';
                
                const remediesList = data.naturalRemedies.map(remedy => `
                    <li class="flex items-start">
                        <svg class="w-5 h-5 text-green-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="text-gray-700">${remedy}</span>
                    </li>
                `).join('');

                resultContent.innerHTML += `
                    <div class="p-3 bg-white rounded-lg border-t border-green-100">
                        <p class="text-sm font-semibold text-gray-600 mb-2">${remediesTitle}</p>
                        <ul class="space-y-2 list-none p-0">${remediesList}</ul>
                    </div>
                `;
            }

            // 4. TOP 3 Recommendation Section 
            const recommendationHeader = isWeedControl ? 'üß™ ‡§ü‡•â‡§™ 3 ‡§§‡§£‡§®‡§æ‡§∂‡§ï ‡§∂‡§ø‡§´‡§æ‡§∞‡§∏‡•Ä (‡§ì‡§≥‡§ñ‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§∏‡§æ‡§Ç‡§ï‡•á‡§§‡§ø‡§ï ‡§ö‡§ø‡§§‡•ç‡§∞ ‡§µ ‡§®‡§æ‡§µ ‡§§‡§™‡§æ‡§∏‡§æ)' : 'üå± ‡§ü‡•â‡§™ 3 ‡§ñ‡§§/‡§ï‡•Ä‡§ü‡§ï‡§®‡§æ‡§∂‡§ï ‡§∂‡§ø‡§´‡§æ‡§∞‡§∏‡•Ä (‡§ì‡§≥‡§ñ‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§∏‡§æ‡§Ç‡§ï‡•á‡§§‡§ø‡§ï ‡§ö‡§ø‡§§‡•ç‡§∞ ‡§µ ‡§®‡§æ‡§µ ‡§§‡§™‡§æ‡§∏‡§æ)';
            const itemBgClass = isWeedControl ? 'bg-orange-50 border-orange-300' : 'bg-lime-50 border-lime-300';
            
            let recommendationsHtml = '';

            data.recommendations.forEach((rec, index) => {
                const imageUrl = getCustomProductPlaceholder(rec.productName, rec.brandName, rec.productType);
                const searchName = `${rec.brandName} ${rec.productName} Indian Packaging`; 

                recommendationsHtml += `
                    <div class="p-4 ${itemBgClass} rounded-lg shadow-md border-2">
                        <h4 class="text-lg font-bold ${isWeedControl ? 'text-orange-700' : 'text-lime-700'} mb-3">‡§∂‡§ø‡§´‡§æ‡§∞‡§∏ #${index + 1}: ${rec.productName}</h4>
                        
                        <div class="flex flex-col sm:flex-row sm:space-x-4 mb-3">
                            <!-- Product Details Section -->
                            <div class="sm:w-1/2 space-y-1">
                                <p class="text-sm text-gray-700">**‡§ï‡§Ç‡§™‡§®‡•Ä/‡§¨‡•ç‡§∞‡§Å‡§°:** <span class="font-medium">${rec.brandName}</span></p>
                                <p class="text-sm text-gray-700">**‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ (Type):** <span class="font-medium">${rec.productType}</span></p>
                                <p class="text-sm text-gray-700">**‡§Ö‡§Ç‡§¶‡§æ‡§ú‡§ø‡§§ ‡§ï‡§ø‡§Ç‡§Æ‡§§:** <span class="font-bold">${rec.priceEstimate}</span></p>
                            </div>
                            
                            <!-- Reliable Visual Aid with Text -->
                            <div class="sm:w-1/2 mt-3 sm:mt-0 p-1 bg-white rounded-md border border-gray-200 flex justify-center items-center">
                                <img 
                                    src="${imageUrl}" 
                                    alt="‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§ì‡§≥‡§ñ - ${rec.productName}" 
                                    class="visual-aid-img"
                                >
                            </div>
                        </div>

                        <!-- USE/DOSAGE (‡§ï‡§∏‡§æ ‡§µ‡§æ‡§™‡§∞‡§æ‡§Ø‡§ö‡§æ) -->
                        <div class="mt-4 p-2 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                            <p class="text-sm font-semibold text-yellow-700">‡§µ‡§æ‡§™‡§∞‡§£‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§™‡§¶‡•ç‡§ß‡§§ ‡§µ ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£ (‡§°‡•ã‡§∏):</p>
                            <p class="text-sm text-gray-700">${rec.dosage}</p>
                        </div>
                        
                        <!-- SIDE EFFECTS/SAFETY (‡§¶‡•Å‡§∑‡•ç‡§™‡§∞‡§ø‡§£‡§æ‡§Æ) -->
                        <div class="mt-2 p-2 bg-red-100 border-l-4 border-red-500 rounded">
                            <p class="text-sm font-semibold text-red-800">‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§‡§§‡§æ ‡§µ ‡§∏‡§Ç‡§≠‡§æ‡§µ‡•ç‡§Ø ‡§¶‡•Å‡§∑‡•ç‡§™‡§∞‡§ø‡§£‡§æ‡§Æ:</p>
                            <p class="text-sm text-red-700">${rec.sideEffects}</p>
                        </div>
                        
                        <!-- Direct Search Text (‡§®‡§æ‡§µ ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä) -->
                        <p class="text-xs text-gray-500 mt-3 border-t pt-2 border-gray-200">
                            <span class="font-semibold text-gray-800">‡§¶‡•Å‡§ï‡§æ‡§®‡§æ‡§§‡•Ä‡§≤ ‡§™‡•Ö‡§ï‡§ø‡§Ç‡§ó/‡§´‡•ã‡§ü‡•ã ‡§∂‡•ã‡§ß‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä:</span>
                            <br>
                            <span id="search-text-${index}" class="copy-text text-sm" onclick="copyToClipboard('${searchName}')">
                                ${searchName} (‡§®‡§æ‡§µ ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•Ç‡§® Google Search ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡§æ)
                            </span>
                        </p>
                    </div>
                `;
            });


            resultContent.innerHTML += `
                <div class="mt-4 p-4 ${isWeedControl ? 'bg-orange-100 border border-orange-400' : 'bg-lime-100 border border-lime-400'} rounded-lg shadow-inner">
                    <h3 class="text-xl font-extrabold ${isWeedControl ? 'text-orange-800' : 'text-lime-800'} border-b ${isWeedControl ? 'border-orange-300' : 'border-lime-300'} pb-2 mb-3">
                        ${recommendationHeader}
                    </h3>
                    
                    <div class="space-y-4">
                        ${recommendationsHtml}
                    </div>
                </div>
            `;


            resultContainer.classList.remove('hidden');
            setTimeout(() => {
                resultContainer.classList.remove('opacity-0');
            }, 10);
        }

    </script>
</body>
</html>

